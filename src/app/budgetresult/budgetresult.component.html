<div class="component">
    <div class="backbutton">
      <img [routerLink]="['/']"  class="backbuttonimg" src="assets/back.png" > 
    </div>
    

  <div class="table-choices-list" style="min-width: 428px;">
  <div><h3>Budget Extract From Contract</h3></div>
  <div style="margin-top: 10px;"><span>Extracted Time : {{response}}</span></div>
  <div *ngFor="let item of tablesData.slice(0, tablesData.length - 1); index as idx" class="table-choice">
    <input type="radio" name="tableSelect" [value]="idx" [(ngModel)]="selectedIndex" />
    <span 
      (click)="onTableToggle(idx,+item.Overhead)" 
      class="caret"
      style="cursor: pointer;"
    >
      {{ selectedIndex === idx ? '▼' : '▶' }}
    </span>
    <span 
      (click)="onTableToggle(idx,+item.Overhead)" 
      class="choice-label"
    >
      {{ item.description }} - {{ item.overall_confidence }} Confidence Level
    </span>
   <span style="position: relative; top: 6px;"><img src="assets/i-bar.svg" [title]="item.Reason"></span>

    <table *ngIf="selectedIndex === idx" class="styled-budget-table">
      <thead>
        <tr>
          <th>Visit</th>
          <th >{{ +item.Overhead > 0 ? 'Rate (with OH - ' + item.Overhead + '%)' : 'Rate (without OH)' }} </th>
          <th >Confidence</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let visit of item.table">
          <tr>
            <td>{{ visit.VISIT_NAME}}</td>
            <td style="text-align: right;">{{ visit.VISIT_COST }}</td>
            <td style="text-align: right;">{{ visit.CONFIDENCE }}</td>
          </tr>
        </ng-container>
        
      </tbody>
      <td style="font-weight: bold;">Total Visit Cost</td>
      <td style="font-weight: bold;text-align: end;">{{item.total_visit_cost}}</td>
    </table>
    
  </div>
</div>

    
    <div class="table-wrapper" style="min-width: 325px;">
              <div class="triple-container">
                <div class="eye-container">
                  <img src="assets/eye.png" height="20px" width="40px"/>
                  View Uploaded Contract
                </div>
                <span id="successPercentage" style="margin-left: 10px; font-weight: bold; color: green;"></span>
                <div id="form-display">
                  <div class="form-item">
                      <label for="studyField">Study</label>
                      <div class="span-div">
                        <!-- <span id="studyValue">9999/2757</span> -->
                        <!-- <select (change)="ongetsite()" [(ngModel)]="selectedStudyId" id="studyValue" name="studyValue"  style="width: 100%; font-size: 14px; padding:5px; border: 0px;">
                          <option value=""  selected><span>Select  Study</span></option>
                           <option *ngFor="let study of studies" [value]="study.studyId">{{ study.studyId }}</option>
                        </select> -->
                        <input type="text" (change)="ongetsite()" [(ngModel)]="selectedStudyId" placeholder="Enter Study" class="studyinput" style="width: 100%; font-size: 14px; padding:0px; border: 0px;"/>

                        
                        
                         
                        
                      </div>
                  </div>
                   <div class="form-item">
                      <label for="siteField">Site</label>
                      <div class="span-div">
                      
                         <select  (change)="ongetpayee()" [(ngModel)]="selectedSiteId" [disabled]="!selectedStudyId" class="siteValue" name="siteValue"  style="width: 100%; font-size: 14px; padding:5px ;border: 0px;">
                          <option value=""  selected><span>Select  Site</span></option>
                          <option *ngFor="let site of sites" [value]="site.siteId">{{ site.siteNum }}</option>
                        </select>
                      </div>
                  </div> 
                   <div class="form-item">
                      <label for="payeeField">Payee</label>
                      <div class="span-div">
                     
                         <select  (change)="ongetschedule()"  [(ngModel)]="selectedPayeeId" [disabled]="!selectedSiteId" id="schedules" name="schedules"  style="width: 100%; font-size: 14px; padding:5px;border: 0px; ">
                          <option value=""  selected><span>Select  Payee</span></option>
                           <option *ngFor="let payee of payees" [value]="payee.payeeId">{{ payee.payeeName }}</option>
                   
                        </select>
                      </div>
                  </div>
                   <div class="form-item">
                      <label for="schedules">Schedules</label>
                      <div class="span-div">
                        
                         <select (change)="ongetpricelist()" [(ngModel)]="selectedScheduleId" [disabled]="!selectedPayeeId" id="schedules" name="schedules"  style="width: 100%; font-size: 14px; padding:5px; border: 0px;">
                          <option value=""  selected><span>Select a Schedule</span></option>
                          <option *ngFor="let schedule of schedules" [value]="schedule.scheduleId">{{ schedule.scheduleName }}</option>
                   
                        </select>
                        
                      </div>
                  </div>
                  <div class="form-item">
                      <label for="payeePricelistField">Payee Pricelist</label>
                      <div class="span-div">
                        <select (change)="ongetEntitlementset()" [(ngModel)]="selectedPriceListId"  [disabled]="!selectedScheduleId"  id="payeePricelistField" name="payeePricelistField"  style="width: 100%; font-size: 14px; padding:5px ; border: 0px;">
                          <option value=""  selected><span>Select Payee Pricelist</span></option>
                          <option *ngFor="let price of priceLists" [value]="price.priceListId">{{ price.priceListName }}</option>
                        </select>
                      </div>
                  </div> 
                   <div class="form-item">
                      <label for="entitlement">Entitlement Sets</label>
                      <div class="span-div">
                       
                        <select [(ngModel)]="selectedEntitlementSetId"  [disabled]="!selectedPriceListId" id="entitlement" name="entitlement"  style="width: 100%; font-size: 14px; padding:5px ; border: 0px;">
                       <option  value=""  selected><span>Select Entitlement</span></option>
                         <option *ngFor="let ent of entitlementSets" [value]="ent.entitlementSetId">{{ ent.entitlementSetId }}</option>
                        </select>
                      </div>
                  </div>
                  

              </div>
              <div class="last-box">
                <div class="input-container">
                  <!-- <div class="input-box">
                    <label for="unscheduledVisits">Unscheduled Visits <span class="colon">:</span></label>
                    <input type="number" id="unscheduledVisits"  />
                  </div> -->
               
                  <!-- <div class="input-box">
                    <label for="cycles">Cycles <span class="colon">:</span></label>
                    <input type="number" id="cycles"  />
                  </div> -->
<!--                
                  <div class="input-box">
                    <label for="followup">Followup <span class="colon">:</span></label>
                    <input type="number" id="followup"  />
                  </div> -->
                  <div class="input-box">
                    <label for="Overhead">Overhead %<span class="colon">:</span></label>
                    <input type="number" id="Overhead"  [disabled]="Overheadval == 0 ? false: true"  [(ngModel)]="Overhead"/>
                   
                  </div>
                  <div class="input-box">
                    <label for="Retention">Retention % <span class="colon">:</span></label>
                    <input type="number" id="Retention"   [(ngModel)]="Retention"/>
                    
                  </div>
                  
                   <!-- <div class="input-box">
                    <label for="Entitlement">Entitlement Set <span class="colon">:</span></label>
                    <input type="text"  id="Entitlement"  [(ngModel)]="Entitlement"/>
                    
                  </div> -->
                </div>
                <div class="button-container">
                  <button id="generateBudgetButton" (click)="onGenerateBudget()">Generate Budget</button>
                </div>
              </div>
              </div>
            </div>
     <div style="width:45%">
        <div><h3>Budget to be entered on APECS</h3></div>
         <div>

          <table id="generatedBudgetTable" style="width: 100%;">
            <!-- <thead>
              <tr>
                <th style="width: 8%;">S.No</th>
              <th styles="width: 22%">Visit Def Desc <img src="assets/filter.svg" style="width: 20px"></th>
    <th style="width: 26%;">Entitlement Name <img src="assets/filter.svg" style="width: 20px"></th>
     <th style="width: 11%;">Rate</th>
    <th style="width: 11%;" >OH Value</th>
    <th>Old value</th> 
    <th style="width: 13%;" >Final rate</th>	
    <th style="width: 9%;">Ret %</th></tr> 
  <th class="fourth-col">actions</th> 
            </thead> -->


            <thead>
  <tr>
    <th style="width: 8%;">S.No</th>
    <th style="width: 22%">Extracted visit names</th>
    <!-- Visit Def Desc -->
   <th style="width: 22%; position: relative;" class="hover-th">
  Visit Def Desc
  <img class="filter-icon"
    src="assets/filter.svg"
    style="width: 20px; cursor: pointer;"
    (mousedown)="openFilter('visitDesc')"
  >
  <!-- Filter Popup -->
  <div
    *ngIf="activeFilter === 'visitDesc'"
    style="
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 10;
      background: white;
      border: 1px solid #ccc;
      padding: 0;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    "
  >
    <input
      type="text"
      [(ngModel)]="visitDescFilterValue"
      placeholder="Search..."
      style="width: 100%; padding: 4px;"
     (change)="onGenerateBudget(visitDescFilterValue,entitlementFilterValue)"
    >
   
  </div>
</th>


  <th style="width: 28%; position: relative;" class="hover-th">
  Entitlement Name
  <img class="filter-icon"
    src="assets/filter.svg"
    style="width: 20px; cursor: pointer;"
    (mousedown)="openFilter('entitlement')"
  >
  <!-- Filter Popup -->
  <div
    *ngIf="activeFilter === 'entitlement'"
    style="
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 10;
      background: white;
      border: 1px solid #ccc;
      padding: 0;
      width: 100%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    "
  >
    <input
      type="text"
      [(ngModel)]="entitlementFilterValue"
      placeholder="Search..."
      style="width: 100%; padding: 4px;"
      (change)="onGenerateBudget(visitDescFilterValue,entitlementFilterValue)"
    >
  </div>
</th>

    <th style="width: 11%;">Rate</th>
    <th style="width: 11%;">OH Value</th>
    <th style="width: 13%;">Final Rate</th>
    <th style="width: 9%;">Ret %</th>
  </tr>
</thead>

          <tbody>
  <!-- Show skeleton rows while loading -->
  <ng-container *ngIf="loading; else dataRows">
    <tr *ngFor="let _ of skeletonRows">
      <td><ngx-skeleton-loader [theme]="{ width: '20px', height: '16px' }"></ngx-skeleton-loader></td>
      <td><ngx-skeleton-loader [theme]="{ width: '100px', height: '16px' }"></ngx-skeleton-loader></td>
      <td><ngx-skeleton-loader [theme]="{ width: '100px', height: '16px' }"></ngx-skeleton-loader></td>
      <td><ngx-skeleton-loader [theme]="{ width: '60px', height: '16px' }"></ngx-skeleton-loader></td>
      <td><ngx-skeleton-loader [theme]="{ width: '60px', height: '16px' }"></ngx-skeleton-loader></td>
      <td><ngx-skeleton-loader [theme]="{ width: '60px', height: '16px' }"></ngx-skeleton-loader></td>
      <td><ngx-skeleton-loader [theme]="{ width: '60px', height: '16px' }"></ngx-skeleton-loader></td>
    </tr>
  </ng-container>

  <!-- Actual data rows -->
  <ng-template #dataRows>
    <tr *ngFor="let row of data; let rowIndex = index">
      <td>{{ rowIndex + 1 }}</td>
      <td (click)="editCell(rowIndex, 'apecsVisitName')">
        <ng-container *ngIf="!isEditing(rowIndex, 'apecsVisitName'); else visitNameInput">
          {{ row.apecsVisitName }}
        </ng-container>
        <ng-template #visitNameInput>
          <input [(ngModel)]="row['apecsVisitName']"
                 (blur)="stopEditing()"
                 (keydown.enter)="stopEditing()"
                 autofocus />
        </ng-template>
      </td>
      <td>
        {{row.baiExtractedVisitName}}
      </td>
      <td (click)="editCell(rowIndex, 'entitlementName')">
        <ng-container *ngIf="!isEditing(rowIndex, 'entitlementName'); else indexInput">
          {{ row.entitlementName }}
        </ng-container>
        <ng-template #indexInput>
          <input [(ngModel)]="row.entitlementName"
                 (blur)="stopEditing()"
                 (keydown.enter)="stopEditing()"
                 autofocus />
        </ng-template>
      </td>
      <td style="text-align: right;" (click)="editCell(rowIndex, 'VISIT COST')">
        <ng-container *ngIf="!isEditing(rowIndex, 'VISIT COST'); else costInput">
          {{ row["Visit Cost"] }}
        </ng-container>
        <ng-template #costInput>
          <input [(ngModel)]="row['VISIT COST']"
                 (blur)="stopEditing()"
                 (keydown.enter)="stopEditing()"
                 autofocus />
        </ng-template>
      </td>
      <td style="text-align: right;" (click)="editCell(rowIndex, 'overhead')">
        <ng-container *ngIf="!isEditing(rowIndex, 'overhead'); else overheadInput">
          {{ row.overhead }}
        </ng-container>
        <ng-template #overheadInput>
          <input [(ngModel)]="row.overhead"
                 (blur)="stopEditing()"
                 (keydown.enter)="stopEditing()"
                 autofocus />
        </ng-template>
      </td>
      <td style="text-align: right;" (click)="editCell(rowIndex, 'Final Visit Rate')">
        <ng-container *ngIf="!isEditing(rowIndex, 'Final Visit Rate'); else finalRateInput">
          {{ row["Final Visit Rate"] }}
        </ng-container>
        <ng-template #finalRateInput>
          <input [(ngModel)]="row['Final Visit Rate']"
                 (blur)="stopEditing()"
                 (keydown.enter)="stopEditing()"
                 autofocus />
        </ng-template>
      </td>
      <td style="text-align: right;" (click)="editCell(rowIndex, 'Retention')">
        <ng-container *ngIf="!isEditing(rowIndex, 'Retention'); else retentionInput">
          {{ row.Retention }}
        </ng-container>
        <ng-template #retentionInput>
          <input [(ngModel)]="row.Retention"
                 (blur)="stopEditing()"
                 (keydown.enter)="stopEditing()"
                 autofocus />
        </ng-template>
      </td>
    </tr>
    <tr *ngIf="flag">
     <td style="font-weight: bold;">Total </td>
  <td style="font-weight: bold;text-align: end;"></td>
   <td style="font-weight: bold;text-align: end;"></td>
   <td style="font-weight: bold;text-align: end;"></td>
      <td style="font-weight: bold;text-align: end;">{{totalVisitCost}}</td>
       <td style="font-weight: bold;text-align: end;"></td>
        <td style="font-weight: bold;text-align: end;">{{totalVisitCost}}</td>
        <td style="font-weight: bold;text-align: end;"></td>
     
 </tr>

        <!-- <div>
  <button (click)="previousPage()" [disabled]="currentPage === 0">
    Previous
  </button>

  Page {{ currentPage + 1 }} of {{ totalPages }}

  <button (click)="nextPage()" [disabled]="currentPage >= totalPages - 1">
    Next
  </button>
</div> -->
  </ng-template>
    
</tbody>


          </table>
           <div style="display: flex;" *ngIf="flag">
  <button  (click)="onGenerateBudget(visitDescFilterValue,entitlementFilterValue,currentPage-1)" [disabled]="currentPage === 0" style="width: max-content;
    margin-left: 15%;
    margin-right: 10%;">
    Previous
  </button>

  Page {{ currentPage + 1 }} of {{ totalPages }}

  <button (click)="onGenerateBudget(visitDescFilterValue,entitlementFilterValue,currentPage+1)" [disabled]="currentPage >= totalPages - 1" style="width: max-content;
    margin-left: 10%;
    margin-right: 10%;">
    Next
  </button>
</div>
         </div>
        <div class="btn-container">
                  <button id="generateSubmitButton" (click)="openModel()" >Save To APECS</button>
               
              
                  <button id="downloadExcelButton" >Download Excel</button>
                
    </div>
    
        </div>
</div>


<!-- feedback-modal.component.html -->
<div class="modal-overlay" *ngIf="showFeedbackModal">
  <div class="modal">
   
    <h2>Budget Has Been Saved To Apecs</h2>

    <label>On a scale of 1-5, how would you rate the result?</label>
    <div class="stars">
      <span
        *ngFor="let star of starsArray; let i = index"
        class="star"
        [class.selected]="selectedRating > i"
        (click)="selectRating(i + 1)"
        >&#9733;</span
      >
    </div>

    <label for="accuracy">How accurate do you think the results were? (0–100%)</label>
    <input
      type="number"
      id="accuracy"
      min="0"
      max="100"
      [(ngModel)]="accuracy"
    />

    <label for="feedback">Feedback</label>
    <textarea
      id="feedback"
      maxlength="2000"
      placeholder="Write your feedback..."
      [(ngModel)]="feedback"
    ></textarea>

    <div class="modal-buttons">
      <button  (click)="submitFeedback()" style="border: 3px solid #00867d;">Ok</button>
      <button  (click)="closeModal()" style="border: 3px solid #00867d;">Cancel</button>
      
    </div>
  </div>
</div>

<!-- Thank You Modal class="ok-btn" class="cancel-btn"       class="ok-btn"-->
<div class="modal-overlay" *ngIf="showThankYouModal">
  <div class="modal thank-you-message">
    <h2>Thank You for your valuable feedback!</h2>
    <button  (click)="closeThankYouModal()" style="display: flex; justify-content: center;margin-left: 35%; width: 25%;">Close</button>
  </div>
</div>
